<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Call Transcriber</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>Call Transcriber</h1>

        <!-- Signup/Login -->
        <div class="auth-section">
            <input type="text" id="username" placeholder="Username">
            <input type="password" id="password" placeholder="Password">
            <button onclick="signup()">Sign Up</button>
            <button onclick="login()">Login</button>
            <div id="authStatus" class="status"></div>
        </div>

        <div class="upload-section">
            <input type="file" id="audioFile" accept=".wav,.mp3">
            <button onclick="uploadFile()">Transcribe</button>
            <div class="status" id="statusMessage"></div>
        </div>

        <div class="search-section">
            <input type="text" id="searchQuery" placeholder="Search keyword...">
            <button onclick="searchTranscript()">Search</button>
        </div>

        <div class="translate-section">
            <select id="languageSelect">
                <option value="en">English</option>
                <option value="zu">Zulu</option>
                <option value="xh">Xhosa</option>
                <option value="st">Sesotho</option>
                <option value="tn">Setswana</option>
                <option value="ts">Tsonga</option>
                <option value="nso">Sepedi</option>
                <option value="af">Afrikaans</option>
                <option value="fr">French</option>
                <option value="de">German</option>
                <option value="es">Spanish</option>
            </select>
            <button onclick="translateTranscript()">Translate</button>
        </div>

        <div class="download-section">
            <button onclick="downloadTranscript()">Download as TXT</button>
        </div>

        <div class="transcript" id="transcriptDisplay">Transcription will appear here...</div>

        <footer>
            &copy; 2025 ShadyJnr Studios. All rights reserved.
        </footer>
    </div>

<script>
let loggedIn = false;

async function signup() {
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();
    const authStatus = document.getElementById('authStatus');

    if (!username || !password) { authStatus.textContent = "Enter username & password."; return; }

    const response = await fetch('/signup', {
        method: 'POST',
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password })
    });

    const data = await response.json();
    authStatus.textContent = data.message;
}

async function login() {
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();
    const authStatus = document.getElementById('authStatus');

    if (!username || !password) { authStatus.textContent = "Enter username & password."; return; }

    const response = await fetch('/login', {
        method: 'POST',
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password })
    });

    const data = await response.json();
    authStatus.textContent = data.message;
    if (data.status === "success") loggedIn = true;
}

async function uploadFile() {
    if (!loggedIn) { alert("You must login first!"); return; }

    const fileInput = document.getElementById('audioFile');
    const status = document.getElementById('statusMessage');
    const transcriptDiv = document.getElementById('transcriptDisplay');

    if (!fileInput.files.length) { alert("Please select a file."); return; }

    const formData = new FormData();
    formData.append('file', fileInput.files[0]);

    status.textContent = "Uploading and transcribing...";

    const response = await fetch('/upload', { method: 'POST', body: formData });
    const data = await response.json();

    status.textContent = data.message;
    if (data.status === "success") transcriptDiv.innerHTML = data.transcript;
}

function searchTranscript() {
    const keyword = document.getElementById('searchQuery').value.trim().toLowerCase();
    const transcriptDiv = document.getElementById('transcriptDisplay');
    if (!keyword) return;

    const regex = new RegExp(`(${keyword})`, 'gi');
    transcriptDiv.innerHTML = transcriptDiv.textContent.replace(regex, '<span class="highlight">$1</span>');
}

async function translateTranscript() {
    if (!loggedIn) { alert("You must login first!"); return; }

    const transcriptDiv = document.getElementById('transcriptDisplay');
    const status = document.getElementById('statusMessage');
    const transcript = transcriptDiv.textContent.trim();
    const targetLang = document.getElementById('languageSelect').value;

    if (!transcript || transcript === "Transcription will appear here...") { alert("Transcribe first."); return; }

    status.textContent = "Translating...";
    const response = await fetch('/translate', {
        method: 'POST',
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ transcript, target_lang: targetLang })
    });

    const data = await response.json();
    status.textContent = data.message || "Translation completed!";
    if (data.status === "success") transcriptDiv.innerHTML = data.translation;
}

function downloadTranscript() {
    if (!loggedIn) { alert("You must login first!"); return; }

    const transcript = document.getElementById('transcriptDisplay').textContent.trim();
    if (!transcript || transcript === "Transcription will appear here...") { alert("No transcript to download."); return; }

    const blob = new Blob([transcript], { type: "text/plain" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "transcript.txt";
    link.click();
}
</script>
</body>
</html>
